<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <link href="style.css" type="text/css" rel="stylesheet">
    <title>Purchase</title>
  </head>
  <body class="main-contents">
    <%- include('partials/nav'); %>
    <main class="main-content">
      <div class="container">
        <h1>Purchase - Record Your Purchases</h1>
        <form id="purchase-form" method="POST" action="/purchase">
          <div class="form-group position-relative">
            <label for="supplierName">Supplier Name:</label>
            <input type="text" class="form-control" id="supplierName" name="supplierName" autocomplete="off" required>
            <div class="dropdown">
              <ul class="dropdown-menu" id="supplier-dropdown" style="width: 100%;">
                <!-- Dynamic supplier list will be inserted here -->
              </ul>
            </div>
          </div>

          <!-- Product Table -->
          <div class="form-group">
            <label for="productTable">Products:</label>
            <table class="table table-bordered" id="productTable">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Quantity</th>
                  <th>Price</th>
                  <th>AddRow <button type="button" id="addProductRow"><i class="bi bi-plus-circle-fill"></i></button></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <div class="position-relative">
                      <input type="text" class="form-control product-input" name="product[]" autocomplete="off" required>
                      <div class="dropdown">
                        <ul class="dropdown-menu product-dropdown" style="width: 100%;">
                          <!-- Dynamic product list will be inserted here -->
                        </ul>
                      </div>
                    </div>
                  </td>
                  <td><input type="number" class="form-control quantity-input" name="quantity[]" min="1" required></td>
                  <td><input type="number" class="form-control price-input" name="price[]" min="0.01" step="0.01" required></td>
                  <td><button type="button" class="btn btn-danger remove-product">Remove</button></td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="2" class="text-end"><strong>Total Cost:</strong></td>
                  <td><input type="text" class="form-control" id="totalCost" readonly></td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </div>
      
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script>
        $(document).ready(function() {
          // Supplier auto-suggest
          $('#supplierName').on('input', function() {
            const query = $(this).val();
            if (query.length > 0) {
              fetch(`/get-suppliers?q=${query}`)
                .then(response => response.json())
                .then(data => {
                  const dropdown = $('#supplier-dropdown');
                  dropdown.empty();
                  if (data.length > 0) {
                    data.forEach(supplier => {
                      dropdown.append(`<li><a class="dropdown-item" href="#">${supplier}</a></li>`);
                    });
                    dropdown.show();
                  } else {
                    dropdown.hide();
                  }
                })
                .catch(error => console.error('Error fetching suppliers:', error));
            } else {
              $('#supplier-dropdown').hide();
            }
          });

          $('#supplier-dropdown').on('click', 'a', function() {
            $('#supplierName').val($(this).text());
            $('#supplier-dropdown').hide();
          });

          $(document).on('click', function(e) {
            if (!$(e.target).closest('#supplierName, #supplier-dropdown').length) {
              $('#supplier-dropdown').hide();
            }
          });

          // Product auto-suggest
          $(document).on('input', '.product-input', function() {
            const input = $(this);
            const query = input.val();
            if (query.length > 0) {
              fetch(`/get-product?q=${query}`)
                .then(response => response.json())
                .then(data => {
                  const dropdown = input.siblings('.dropdown').find('.product-dropdown');
                  dropdown.empty();
                  if (data.length > 0) {
                    data.forEach(product => {
                      dropdown.append(`<li><a class="dropdown-item" href="#">${product}</a></li>`);
                    });
                    dropdown.show();
                  } else {
                    dropdown.hide();
                  }
                })
                .catch(error => console.error('Error fetching products:', error));
            } else {
              input.siblings('.dropdown').find('.product-dropdown').hide();
            }
          });

          $(document).on('click', '.product-dropdown a', function() {
            const input = $(this).closest('tr').find('.product-input');
            input.val($(this).text());
            input.siblings('.dropdown').find('.product-dropdown').hide();
          });

          // Add new product row
          $('#addProductRow').click(function() {
            const newRow = `
              <tr>
                <td>
                  <div class="position-relative">
                    <input type="text" class="form-control product-input" name="product[]" autocomplete="off" required>
                    <div class="dropdown">
                      <ul class="dropdown-menu product-dropdown" style="width: 100%;">
                        <!-- Dynamic product list will be inserted here -->
                      </ul>
                    </div>
                  </div>
                </td>
                <td><input type="number" class="form-control quantity-input" name="quantity[]" min="1" required></td>
                <td><input type="number" class="form-control price-input" name="price[]" min="0.01" step="0.01" required></td>
                <td><button type="button" class="btn btn-danger remove-product">Remove</button></td>
              </tr>
            `;
            $('#productTable tbody').append(newRow);
          });

          // Remove product row
          $(document).on('click', '.remove-product', function() {
            $(this).closest('tr').remove();
            calculateTotalCost(); // Recalculate total cost after removing a row
          });

          // Calculate total cost function
          function calculateTotalCost() {
            let totalCost = 0;
            $('#productTable tbody tr').each(function() {
              const quantity = $(this).find('.quantity-input').val();
              const price = $(this).find('.price-input').val();
              if (quantity && price) {
                totalCost += (quantity * price);
              }
            });
            $('#totalCost').val(totalCost.toFixed(2)); // Update total cost display
          }

          // Calculate total cost on input change
          $(document).on('input', '.quantity-input, .price-input', function() {
            calculateTotalCost();
          });

        });
      </script>
    </main>
  </body>
</html>
